generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Course {
  id           String        @id @default(uuid())
  title        String
  description  String
  thumbnail    String?
  difficulty   String        @default("Beginner")
  duration     String?
  isPublished  Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  enrollments  Enrollment[]
  lessons      Lesson[]
  modules      Module[]
  labs         Lab[]
  certificates Certificate[]

  @@map("courses")
}

model Enrollment {
  id          String    @id @default(uuid())
  userId      String
  courseId    String
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

model Module {
  id          String    @id @default(uuid())
  title       String
  description String?
  order       Int
  courseId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons     Lesson[]
  labs        Lab[]

  @@map("modules")
}

model Lesson {
  id        String    @id @default(uuid())
  title     String
  content   String
  videoUrl  String?
  order     Int
  courseId  String
  moduleId  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module    Module?   @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  progress  Progress[]
  quiz      Quiz?

  @@map("lessons")
}

model Progress {
  id          String    @id @default(uuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("progress")
}

model Question {
  id            String  @id @default(uuid())
  quizId        String
  question      String
  options       String[]
  correctAnswer Int
  order         Int
  quiz          Quiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@map("questions")
}

model QuizAttempt {
  id          String   @id @default(uuid())
  userId      String
  quizId      String
  score       Int
  passed      Boolean
  attemptedAt DateTime @default(now())
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("quiz_attempts")
}

model Quiz {
  id           String        @id @default(uuid())
  lessonId     String        @unique
  title        String
  passingScore Int           @default(70)
  questions    Question[]
  attempts     QuizAttempt[]
  lesson       Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("quizzes")
}

model User {
  id                   String        @id @default(uuid())
  email                String        @unique
  password             String
  firstName            String
  lastName             String
  role                 Role          @default(STUDENT)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  lastLoginAt          DateTime?

  // Login attempt tracking
  loginAttempts        Int           @default(0)
  lastFailedLogin      DateTime?
  accountLockedUntil   DateTime?

  // Settings
  emailNotifications   Boolean       @default(true)
  courseReminders      Boolean       @default(true)
  marketingEmails      Boolean       @default(false)
  showProgress         Boolean       @default(true)
  autoPlayVideos       Boolean       @default(true)

  enrollments          Enrollment[]
  progress             Progress[]
  quizAttempts         QuizAttempt[]
  certificates         Certificate[]
  labProgress          LabProgress[]

  @@map("users")
}

model Certificate {
  id       String   @id @default(uuid())
  userId   String
  courseId String
  issuedAt DateTime @default(now())
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("certificates")
}

enum Role {
  STUDENT
  ADMIN
}

model Lab {
  id              String        @id @default(uuid())
  title           String
  description     String
  difficulty      String        @default("Beginner")
  estimatedTime   Int?
  order           Int
  courseId        String
  moduleId        String?
  isPublished     Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Template-based fields
  labType         LabType       @default(CONTENT)
  simulationConfig Json?        // Template-specific configuration
  passingScore    Int           @default(70)

  // Legacy fields (kept for existing content labs)
  instructions    String?
  scenario        String?
  objectives      String[]
  resources       String?
  hints           String?

  course          Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module          Module?       @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  progress        LabProgress[]

  @@map("labs")
}

model LabProgress {
  id          String    @id @default(uuid())
  userId      String
  labId       String
  status      LabStatus @default(NOT_STARTED)
  timeSpent   Int       @default(0)
  notes       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Scoring fields for interactive labs
  score       Int?      // Percentage score (0-100)
  passed      Boolean?  // Did they meet passing score?
  attempts    Int       @default(0)  // Number of attempts
  answers     Json?     // Store their answers for review

  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lab         Lab       @relation(fields: [labId], references: [id], onDelete: Cascade)

  @@unique([userId, labId])
  @@map("lab_progress")
}

enum LabStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum LabType {
  CONTENT           // Legacy content-based labs
  PHISHING_EMAIL    // Email simulation
  SUSPICIOUS_LINKS  // URL analysis
  PASSWORD_STRENGTH // Password creation exercise
  SOCIAL_ENGINEERING // Chat/message simulation
  SECURITY_ALERTS   // Fake popup identification
  WIFI_SAFETY       // Network selection
  INCIDENT_RESPONSE // Decision tree scenario
}

model PlatformSettings {
  id                        String   @id @default("singleton") // Singleton pattern

  // General
  platformName              String   @default("CyberGuard AI")
  platformDescription       String   @default("Advanced cybersecurity training platform")
  supportEmail              String   @default("support@cyberguard.com")
  contactEmail              String   @default("contact@cyberguard.com")

  // Security
  requireEmailVerification  Boolean  @default(false)
  minPasswordLength         Int      @default(6)
  sessionTimeout            Int      @default(7)
  enableTwoFactor           Boolean  @default(false)
  maxLoginAttempts          Int      @default(5)

  // Course Settings
  autoEnrollNewUsers        Boolean  @default(false)
  defaultCourseVisibility   String   @default("public")
  defaultQuizPassingScore   Int      @default(70)
  enableCertificates        Boolean  @default(true)
  allowCourseReviews        Boolean  @default(true)

  // User Settings
  defaultUserRole           String   @default("STUDENT")
  allowSelfRegistration     Boolean  @default(true)
  requireProfileCompletion  Boolean  @default(false)
  enablePublicProfiles      Boolean  @default(false)

  // Email/Notifications
  enableEmailNotifications  Boolean  @default(false)
  enableEnrollmentEmails    Boolean  @default(true)
  enableCompletionEmails    Boolean  @default(true)
  enableWeeklyDigest        Boolean  @default(false)
  smtpHost                  String   @default("")
  smtpPort                  String   @default("587")
  smtpUser                  String   @default("")
  smtpPassword              String   @default("")

  // Appearance
  primaryColor              String   @default("#3b82f6")
  secondaryColor            String   @default("#10b981")
  accentColor               String   @default("#f59e0b")
  logoUrl                   String   @default("")
  favicon                   String   @default("")
  customCss                 String   @default("")
  fontFamily                String   @default("Inter")
  fontSize                  String   @default("normal")
  borderRadius              String   @default("medium")
  darkModeDefault           Boolean  @default(false)

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@map("platform_settings")
}

model SettingsAuditLog {
  id          String   @id @default(uuid())
  adminId     String
  adminEmail  String
  action      String   @default("UPDATE")
  fieldName   String
  oldValue    String?
  newValue    String?
  ipAddress   String?
  timestamp   DateTime @default(now())

  @@index([adminId])
  @@index([timestamp])
  @@map("settings_audit_log")
}
